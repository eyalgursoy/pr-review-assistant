# AI Review Context Awareness — Summary

---

## File Roles (Read This First)

This implementation uses **three coordinated files**. Each has a specific purpose:

| File | Purpose | When to Use |
|------|---------|-------------|
| **[ai-review-context-plan.md](ai-review-context-plan.md)** | Master plan with detailed specifications | Reference for implementation details, code snippets, and requirements |
| **[ai-review-context-tasks.md](ai-review-context-tasks.md)** | Task checklist with completion status | Check/update task progress, see what's done vs pending |
| **[ai-review-context-summary.md](ai-review-context-summary.md)** (THIS FILE) | Running summary of completed work | **READ BEFORE EACH TASK** to understand prior context |

### For AI Agents: READ THIS FILE FIRST!

**Before starting ANY task, you MUST:**
1. Read this ENTIRE file to understand what has been done
2. Check [ai-review-context-tasks.md](ai-review-context-tasks.md) to see which task is next
3. Reference [ai-review-context-plan.md](ai-review-context-plan.md) for implementation details
4. Create a new branch for the task before implementing

**After completing a task, you MUST update this file with:**
- Task number and branch name
- Date completed
- Summary of changes made
- Files modified
- Key decisions or deviations from plan
- Any issues encountered and how they were resolved

---

## Key Terminology

| Term | Meaning |
|------|---------|
| `source: 'ai'` | Comment generated by the AI review in this session |
| `source: 'host'` | Comment fetched from GitHub/GitLab/Bitbucket (including previously submitted reviews) |
| `status` | Local user decision: `pending`, `approved`, `rejected` — persisted in Task 4 |

---

## Completed Tasks

### Task 1: Inject Existing Host Comments into AI Prompt

**Branch:** `task/1-inject-host-comments-into-prompt`
**Date:** 2026-02-19

**Changes Made:**

- **`src/review-template.ts`**: Added optional 7th parameter `existingComments?: ReviewComment[]` to `buildReviewPrompt`. When present and non-empty, the prompt now includes an "Already Filed Comments" section (before "## Code Changes") listing each comment as `**file:line** — issue` and instructing the AI not to repeat them.
- **`src/extension.ts`**: In `runReview()`, collect `hostComments = getAllComments().filter(c => c.source === "host")` and pass them to `buildReviewPrompt(..., hostComments)`.
- **`src/review-template.test.ts`**: Added 4 tests: no section when no/empty existing comments; section present with correct content when host comments provided; section placed before "## Code Changes".

**Files Modified:** `src/review-template.ts`, `src/extension.ts`, `src/review-template.test.ts`, `package.json`, `README.md`, `CHANGELOG.md`, `docs/ai-review-context-tasks.md`, `docs/ai-review-context-summary.md`

**Test Results:** 272/272 pass

---

### Task 2: Deduplicate AI Comments Before Adding

**Branch:** `task/2-dedup-ai-comments`
**Date:** 2026-02-19

**Changes Made:**

- **`src/state.ts`**: Added `deduplicateComments(incoming, existing)`. Filters out any incoming comment that has the same file and line within ±1 of an existing comment.
- **`src/extension.ts`**: In `runReview()`, after `runAIReview` returns, call `getAllComments()` and `deduplicateComments(result.comments, existingComments)`. Add only `uniqueComments`; when all are duplicates, show "AI found no new issues beyond those already filed." Log and user messages use `uniqueComments.length`.
- **`src/state.test.ts`**: Added 5 tests for deduplicateComments (all when empty existing, exact same file+line, ±1 tolerance, different file same line, same file line diff > 1).

**Files Modified:** `src/state.ts`, `src/extension.ts`, `src/state.test.ts`, `package.json`, `README.md`, `CHANGELOG.md`, `docs/ai-review-context-tasks.md`, `docs/ai-review-context-summary.md`

**Test Results:** 277/277 pass

---

### Task 3: Clear Stale AI Comments Before Re-run

**Branch:** `task/3-clear-ai-comments-on-rerun`
**Date:** 2026-02-19

**Changes Made:**

- **`src/state.ts`**: Added `clearAIComments()`. Removes all comments with `source === 'ai'`, preserves host comments, and prunes file entries that end up with no comments.
- **`src/extension.ts`**: At the start of `runReview()` (after validation, inside try), check `getAllComments().some(c => c.source === 'ai')` and call `clearAIComments()` if true so re-run shows only fresh AI results.
- **`src/state.test.ts`**: Added 4 tests for clearAIComments (removes AI comments, preserves host, empty state no throw, prunes empty files).

**Files Modified:** `src/state.ts`, `src/extension.ts`, `src/state.test.ts`, `package.json`, `README.md`, `CHANGELOG.md`, `docs/ai-review-context-tasks.md`, `docs/ai-review-context-summary.md`

**Test Results:** 281/281 pass

---

## Test Commands

```bash
npm test
npm test -- src/review-template.test.ts
npm test -- src/state.test.ts
npm run build
npm run package
```

---

## Commit Message Format

```
feat(scope): short description

- Detail 1
- Detail 2

Refs: Task N from ai-review-context-plan
```
